name: Parkfolio Collector

on:
  schedule:
    - cron: '*/5 * * * *'   # every 5 minutes
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: parkfolio-cron
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Health check (quick)
        env:
          BASE_URL: ${{ secrets.BASE_URL || secrets.VERCEL_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          set -euo pipefail
          if [ -z "${CRON_SECRET:-}" ]; then
            echo "CRON_SECRET is not configured."
            exit 1
          fi
          BASE_URL="${BASE_URL:-https://parkfolio.vercel.app}"
          BASE_URL="${BASE_URL%/}"
          echo "Health check…"
          curl -fsSL "$BASE_URL/api/cron/collect-queue-times?secret=$CRON_SECRET&quick=true" >/dev/null
          echo "OK"

      - name: Run full collection
        env:
          BASE_URL: ${{ secrets.BASE_URL || secrets.VERCEL_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          set -euo pipefail
          if [ -z "${CRON_SECRET:-}" ]; then
            echo "CRON_SECRET is not configured."
            exit 1
          fi
          BASE_URL="${BASE_URL:-https://parkfolio.vercel.app}"
          BASE_URL="${BASE_URL%/}"
          echo "Triggering Parkfolio cron collector…"
          # retry up to 3 times in case of transient network issues
          for i in 1 2 3; do
            TMP_BODY="$(mktemp)"
            HTTP_STATUS="$(curl -sS -o "$TMP_BODY" -w "%{http_code}" "$BASE_URL/api/cron/collect-queue-times?secret=$CRON_SECRET" || echo "000")"
            RESP="$(cat "$TMP_BODY")"
            rm -f "$TMP_BODY"

            if [ "$HTTP_STATUS" = "000" ]; then
              echo "Network error on attempt $i/3"
              sleep 5
              continue
            fi

            echo "Collector HTTP status: $HTTP_STATUS"
            echo "$RESP"

            if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -ge 300 ]; then
              # Retry only for server-side errors; fail fast for auth/client issues.
              if [ "$HTTP_STATUS" -ge 500 ] && [ "$i" -lt 3 ]; then
                echo "Server error on attempt $i/3, retrying…"
                sleep 5
                continue
              fi
              echo "Collector returned non-2xx response ($HTTP_STATUS)" >&2
              exit 1
            fi

            if ! printf '%s' "$RESP" | jq -e . >/dev/null 2>&1; then
              echo "Collector response is not valid JSON" >&2
              exit 1
            fi

            success="$(printf '%s' "$RESP" | jq -r '.success // false')"
            run_id="$(printf '%s' "$RESP" | jq -r '.runId // \"unknown\"')"
            contract_version="$(printf '%s' "$RESP" | jq -r '.contractVersion // empty')"

            if [ "$success" != "true" ]; then
              echo "Collector reported success=false (runId=$run_id)" >&2
              exit 1
            fi

            if [ "$contract_version" != "collect-queue-times/v1" ]; then
              echo "Collector contract mismatch (expected collect-queue-times/v1, got ${contract_version:-missing})" >&2
              exit 1
            fi

            required_numeric_fields=(
              "supabaseWaitInserted:.stats.supabaseWaitInserted"
              "supabaseWeatherInserted:.stats.supabaseWeatherInserted"
              "tursoWaitInserted:.stats.tursoWaitInserted"
              "tursoWeatherInserted:.stats.tursoWeatherInserted"
              "parksTargeted:.stats.parksTargeted"
              "parksProcessed:.stats.parksProcessed"
              "weatherEligibleParksProcessed:.stats.weatherEligibleParksProcessed"
              "timedOutParks:.stats.timedOutParks"
              "timeoutRate:.stats.timeoutRate"
            )

            for pair in "${required_numeric_fields[@]}"; do
              field="${pair%%:*}"
              jq_path="${pair#*:}"
              value="$(printf '%s' "$RESP" | jq -r "${jq_path} // empty")"
              if ! [[ "$value" =~ ^-?[0-9]+([.][0-9]+)?$ ]]; then
                echo "Collector response missing numeric stats field: $field" >&2
                exit 1
              fi
            done

            supabase_wait="$(printf '%s' "$RESP" | jq -r '.stats.supabaseWaitInserted')"
            supabase_weather="$(printf '%s' "$RESP" | jq -r '.stats.supabaseWeatherInserted')"
            turso_wait="$(printf '%s' "$RESP" | jq -r '.stats.tursoWaitInserted')"
            turso_weather="$(printf '%s' "$RESP" | jq -r '.stats.tursoWeatherInserted')"
            parks_processed="$(printf '%s' "$RESP" | jq -r '.stats.parksProcessed')"
            weather_eligible_processed="$(printf '%s' "$RESP" | jq -r '.stats.weatherEligibleParksProcessed')"
            timed_out_parks="$(printf '%s' "$RESP" | jq -r '.stats.timedOutParks')"
            parks_targeted="$(printf '%s' "$RESP" | jq -r '.stats.parksTargeted')"
            timeout_rate="$(printf '%s' "$RESP" | jq -r '.stats.timeoutRate')"
            critical_failure="$(printf '%s' "$RESP" | jq -r '.criticalFailure // false')"

            if [ "$parks_processed" -gt 0 ] && [ "$supabase_wait" -eq 0 ]; then
              echo "Critical: Supabase wait insert counter is zero after processing parks ($parks_processed)" >&2
              exit 1
            fi
            if [ "$parks_processed" -gt 0 ] && [ "$turso_wait" -eq 0 ]; then
              echo "Critical: Turso wait insert counter is zero after processing parks ($parks_processed)" >&2
              exit 1
            fi
            if [ "$weather_eligible_processed" -gt 0 ] && [ "$supabase_weather" -eq 0 ]; then
              echo "Critical: Supabase weather insert counter is zero after processing weather-eligible parks ($weather_eligible_processed)" >&2
              exit 1
            fi
            if [ "$weather_eligible_processed" -gt 0 ] && [ "$turso_weather" -eq 0 ]; then
              echo "Critical: Turso weather insert counter is zero after processing weather-eligible parks ($weather_eligible_processed)" >&2
              exit 1
            fi

            if awk "BEGIN {exit !($timeout_rate >= 0.2)}"; then
              echo "Critical: timeout threshold breached (${timed_out_parks}/${parks_targeted} parks, rate=${timeout_rate})" >&2
              exit 1
            fi

            if [ "$critical_failure" = "true" ]; then
              echo "Collector flagged criticalFailure=true (runId=$run_id)" >&2
              exit 1
            fi

            echo "Validated collector run $run_id: contract=$contract_version, parksProcessed=$parks_processed, supabaseWait=$supabase_wait, tursoWait=$turso_wait, supabaseWeather=$supabase_weather, tursoWeather=$turso_weather, timeoutRate=$timeout_rate"

            exit 0
          done
          echo "Failed to trigger Parkfolio cron after retries" >&2
          exit 1
