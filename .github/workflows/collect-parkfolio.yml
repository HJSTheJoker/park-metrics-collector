name: Parkfolio Collector

on:
  schedule:
    - cron: '*/5 * * * *'   # every 5 minutes
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: parkfolio-cron
  cancel-in-progress: true

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Health check (quick)
        env:
          BASE_URL: ${{ secrets.BASE_URL || secrets.VERCEL_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          set -euo pipefail
          if [ -z "${CRON_SECRET:-}" ]; then
            echo "CRON_SECRET is not configured."
            exit 1
          fi
          BASE_URL="${BASE_URL:-https://parkfolio.vercel.app}"
          BASE_URL="${BASE_URL%/}"
          echo "Health check…"
          curl -fsSL "$BASE_URL/api/cron/collect-queue-times?secret=$CRON_SECRET&quick=true" >/dev/null
          echo "OK"

      - name: Run full collection
        env:
          BASE_URL: ${{ secrets.BASE_URL || secrets.VERCEL_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          set -euo pipefail
          if [ -z "${CRON_SECRET:-}" ]; then
            echo "CRON_SECRET is not configured."
            exit 1
          fi
          BASE_URL="${BASE_URL:-https://parkfolio.vercel.app}"
          BASE_URL="${BASE_URL%/}"
          echo "Triggering Parkfolio cron collector…"
          # retry up to 3 times in case of transient network issues
          for i in 1 2 3; do
            TMP_BODY="$(mktemp)"
            HTTP_STATUS="$(curl -sS -o "$TMP_BODY" -w "%{http_code}" "$BASE_URL/api/cron/collect-queue-times?secret=$CRON_SECRET" || echo "000")"
            RESP="$(cat "$TMP_BODY")"
            rm -f "$TMP_BODY"

            if [ "$HTTP_STATUS" = "000" ]; then
              echo "Network error on attempt $i/3"
              sleep 5
              continue
            fi

            echo "Collector HTTP status: $HTTP_STATUS"
            echo "$RESP"

            if [ "$HTTP_STATUS" -lt 200 ] || [ "$HTTP_STATUS" -ge 300 ]; then
              # Retry only for server-side errors; fail fast for auth/client issues.
              if [ "$HTTP_STATUS" -ge 500 ] && [ "$i" -lt 3 ]; then
                echo "Server error on attempt $i/3, retrying…"
                sleep 5
                continue
              fi
              echo "Collector returned non-2xx response ($HTTP_STATUS)" >&2
              exit 1
            fi

            COLLECT_RESP="$RESP" node - <<'NODE'
            const fail = (msg) => {
              console.error(msg)
              process.exit(1)
            }

            let parsed
            try {
              parsed = JSON.parse(process.env.COLLECT_RESP || '{}')
            } catch (error) {
              fail(`Collector response is not valid JSON: ${String(error)}`)
            }

            if (parsed.success !== true) {
              fail(`Collector reported success=false (runId=${parsed.runId ?? 'unknown'})`)
            }

            const contractVersion = String(parsed.contractVersion ?? '')
            if (contractVersion !== 'collect-queue-times/v1') {
              fail(`Collector contract mismatch (expected collect-queue-times/v1, got ${contractVersion || 'missing'})`)
            }

            const stats = parsed.stats || {}
            const requiredNumericFields = [
              'supabaseWaitInserted',
              'supabaseWeatherInserted',
              'tursoWaitInserted',
              'tursoWeatherInserted',
              'parksTargeted',
              'parksProcessed',
              'timedOutParks',
              'timeoutRate',
            ]

            for (const field of requiredNumericFields) {
              const value = Number(stats[field])
              if (!Number.isFinite(value)) {
                fail(`Collector response missing numeric stats field: ${field}`)
              }
            }

            const supabaseWait = Number(stats.supabaseWaitInserted ?? 0)
            const supabaseWeather = Number(stats.supabaseWeatherInserted ?? 0)
            const tursoWait = Number(stats.tursoWaitInserted ?? 0)
            const tursoWeather = Number(stats.tursoWeatherInserted ?? 0)
            const parksProcessed = Number(stats.parksProcessed ?? 0)
            const weatherEligibleParksProcessed = Number(stats.weatherEligibleParksProcessed ?? 0)

            if (parksProcessed > 0 && supabaseWait === 0) {
              fail(`Critical: Supabase wait insert counter is zero after processing parks (${parksProcessed})`)
            }
            if (parksProcessed > 0 && tursoWait === 0) {
              fail(`Critical: Turso wait insert counter is zero after processing parks (${parksProcessed})`)
            }
            if (weatherEligibleParksProcessed > 0 && supabaseWeather === 0) {
              fail(
                `Critical: Supabase weather insert counter is zero after processing weather-eligible parks (${weatherEligibleParksProcessed})`
              )
            }
            if (weatherEligibleParksProcessed > 0 && tursoWeather === 0) {
              fail(
                `Critical: Turso weather insert counter is zero after processing weather-eligible parks (${weatherEligibleParksProcessed})`
              )
            }

            const timedOutParks = Number(stats.timedOutParks ?? 0)
            const parksTargeted = Number(stats.parksTargeted ?? 0)
            const timeoutRate = Number.isFinite(Number(stats.timeoutRate))
              ? Number(stats.timeoutRate)
              : (parksTargeted > 0 ? timedOutParks / parksTargeted : 0)

            if (timeoutRate >= 0.2) {
              fail(
                `Critical: timeout threshold breached (${timedOutParks}/${parksTargeted} parks, rate=${timeoutRate.toFixed(3)})`
              )
            }

            if (parsed.criticalFailure === true) {
              fail(`Collector flagged criticalFailure=true (runId=${parsed.runId ?? 'unknown'})`)
            }

            console.log(
              `Validated collector run ${parsed.runId ?? 'unknown'}: contract=${contractVersion}, parksProcessed=${parksProcessed}, supabaseWait=${supabaseWait}, tursoWait=${tursoWait}, supabaseWeather=${supabaseWeather}, tursoWeather=${tursoWeather}, timeoutRate=${timeoutRate.toFixed(3)}`
            )
NODE

            exit 0
          done
          echo "Failed to trigger Parkfolio cron after retries" >&2
          exit 1
